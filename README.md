# Сетевое приложение клиент-сервер для передачи файлов с использованием протокола TCP.

## Сборка проекта

### Сборка с помощью Visual Studio

1. Откройте "Developer Command Prompt for VS" или "x64 Native Tools Command Prompt"
2. Перейдите в директорию проекта
3. Запустите `build.bat`

### Сборка с помощью MinGW

1. Убедитесь, что MinGW установлен и добавлен в PATH
2. Запустите `build_mingw.bat`

### Сборка с помощью CMake

```bash
mkdir build
cd build
cmake ..
cmake --build .
```

## Использование

### Запуск сервера

```bash
server.exe
```

Сервер будет слушать на порту 3333 и принимать подключения от клиентов.

**Настройки сервера:**
- Порт: 3333 (можно изменить в `server.cpp`, константа `MY_PORT`)
- Версия сервера: 2 (бинарные файлы) - можно изменить на 1 (текстовые файлы) в `server.cpp`
- Разрешенные IP-адреса: настраиваются в функции `initAllowedIPs()` в `server.cpp`
- Предустановленный пользователь: `admin` / `admin123`

### Запуск клиента

```bash
client.exe <filename> [username] [password]
```

**Примеры:**
```bash
# Передача файла с аутентификацией
client.exe test.txt admin admin123

# Регистрация нового пользователя (если пользователь не существует)
client.exe document.pdf newuser password123
```

## Функциональность

### Протокол прикладного уровня

Приложение использует собственный протокол прикладного уровня с поддержкой:
- Обмена версиями между клиентом и сервером
- Аутентификации пользователей
- Регистрации новых пользователей
- Передачи файлов (текстовых и бинарных)
- Обработки ошибок

### Возможности сервера

- Поддержка множественных одновременных подключений (многопоточность)
- Проверка версии сервера
- Сохранение текстовых файлов (версия 1)
- Сохранение бинарных файлов (версия 2)
- Проверка соответствия типа файла версии сервера
- Фильтрация IP-адресов клиентов
- Аутентификация пользователей
- Регистрация новых пользователей
- Обработка ошибок сетевого взаимодействия

### Возможности клиента

- Определение версии сервера
- Передача текстовых файлов (если версия сервера = 1)
- Передача бинарных файлов (если версия сервера = 2)
- Аутентификация при подключении
- Регистрация новых пользователей
- Обработка ошибок сетевого взаимодействия

## Коды ошибок

- `ERROR_INVALID_VERSION` (0x01) - Неверная версия
- `ERROR_AUTH_FAILED` (0x02) - Ошибка аутентификации
- `ERROR_IP_NOT_ALLOWED` (0x03) - IP-адрес не из разрешённого пула
- `ERROR_FILE_TYPE_MISMATCH` (0x04) - Сервер не поддерживает обработку файла данного типа (текстовый \ бинарный)
- `ERROR_FILE_TOO_LARGE` (0x05) - Файл слишком большой
- `ERROR_INVALID_MESSAGE` (0x06) - Неверное сообщение
- `ERROR_USER_EXISTS` (0x07) - Пользователь уже существует
- `ERROR_REGISTRATION_FAILED` (0x08) - Ошибка регистрации

## Функции программ

### Программа-клиент (`client.cpp`)

| Функция | Описание |
|--------|----------|
| `getServerVersion(sock, version)` | Запрашивает версию сервера (0x01), получает ответ (0x02), записывает версию в `version`. Возвращает `true` при успехе. |
| `authenticate(sock, username, password)` | Отправляет запрос аутентификации (0x03) с логином и паролем, получает ответ (0x04). Возвращает `true`, если `success == 1`. |
| `registerUser(sock, username, password)` | Отправляет запрос регистрации (0x05), получает ответ (0x06). Возвращает `true` при успешной регистрации. |
| `sendFile(sock, filename, serverVersion)` | Определяет тип файла по версии сервера (1 — текст, 2 — бинарный), открывает файл, отправляет заголовок (0x07) и данные, ожидает MSG_FILE_RESPONSE (0x08) или MSG_ERROR (0xFF). |
| `handleError(sock)` | Проверяет наличие сообщения об ошибке (0xFF) и выводит его в консоль. |
| `main(argc, argv)` | Инициализация Winsock, создание сокета, подключение к серверу; последовательно: запрос версии → аутентификация (при неудаче — попытка регистрации) → передача файла; закрытие сокета и Winsock. |

### Программа-сервер (`server.cpp`)

| Функция | Описание |
|--------|----------|
| `initUsers()` | Инициализирует хранилище пользователей (демо-пользователь `admin` / `admin123`). |
| `initAllowedIPs()` | Заполняет список разрешённых диапазонов IP (например, 127.0.0.1–127.0.0.255). |
| `isIPAllowed(ip)` | Проверяет, входит ли IP в разрешённые диапазоны. Используется при `accept`. |
| `authenticateUser(username, password)` | Проверяет учётные данные по хранилищу пользователей (под защитой `cs_users`). |
| `registerUser(username, password)` | Регистрирует нового пользователя, если его ещё нет. Возвращает `false`, если пользователь существует. |
| `sendError(sock, errorCode, errorText)` | Формирует и отправляет сообщение об ошибке (0xFF) с кодом и текстом. |
| `ServiceToClient(client_socket)` | Потоковая функция: цикл приёма заголовка и тела сообщения; обработка MSG_VERSION_REQUEST, MSG_AUTH_REQUEST, MSG_REGISTER_REQUEST, MSG_FILE_TRANSFER; при неверном типе — MSG_ERROR. Для файла проверяет аутентификацию, тип файла/версию, размер, приём данных, сохранение; ответ MSG_FILE_RESPONSE или MSG_ERROR. |
| `main(argc, argv)` | Инициализация критических секций, пользователей и IP; создание сокета, `bind`, `listen`; цикл `accept` с проверкой IP, инкремент `nclients`, запуск потока `ServiceToClient` для каждого клиента. |

### Общий протокол (`protocol.cpp`, `protocol.h`)

| Функция | Описание |
|--------|----------|
| `sendAll(sock, data, len)` | Отправляет все байты буфера до конца или до ошибки. |
| `recvAll(sock, data, len)` | Принимает ровно `len` байт или возвращает ошибку. |
| `sendMessage(sock, data, size)` | Отправка сообщения через `sendAll`. |
| `receiveMessage(sock, data, size)` | Приём сообщения через `recvAll`. |

## Примечания

- Файлы, полученные сервером, сохраняются в текущей директории с префиксом `received_`
- Пользователи хранятся в памяти (в реальном приложении следует использовать базу данных)
- IP-фильтрация настроена для локальных адресов (127.0.0.1 - 127.0.0.255)
- Максимальный размер файла ограничен размером буфера (64 КБ)
